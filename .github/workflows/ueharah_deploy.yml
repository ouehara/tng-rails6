# name: Push Docker Image to AWS ECR and Deploy to ECS (staging)

# on:
#   push:
#     branches:
#       - feature/stg-miyagi-0927-refactor-m-aws0928-ueharah
#       - develop
#   workflow_dispatch: {}

# env:
#   AWS_REGION: ap-northeast-1
#   AWS_ACCOUNT_ID: 113434362347
#   AWS_ROLE_ARN: arn:aws:iam::113434362347:role/x-rails-0928-GitHubActionsOIDCRole
#   ECR_REPOSITORY: ecr-x-rails-0928-apnortheast1
#   ECS_CLUSTER_NAME: x-rails-0928-dev-apn1-cluster
#   ECS_SERVICE_NAME: x-rails-0928-dev-apn1-service
#   S3_ASSETS_BUCKET: x-rails-0928-dev-apn1-static-assets-u8yhfbq6
#   LATEST_TAG: dev-latest 

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     timeout-minutes: 20
#     permissions:
#       id-token: write
#       contents: read
#     outputs:
#       image-tag: ${{ steps.build-info.outputs.image-tag }}
#       image-uri: ${{ steps.build-info.outputs.image-uri }}

#     steps:
#       - name: Checkout source code
#         uses: actions/checkout@v4

#       - name: Configure AWS credentials (OIDC)
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           role-to-assume: ${{ env.AWS_ROLE_ARN }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Login to Amazon ECR
#         uses: aws-actions/amazon-ecr-login@v1

#       - name: Generate build info
#         id: build-info
#         run: |
#           IMAGE_TAG=$(TZ=Asia/Tokyo date +%Y%m%d-%H%M)
#           BUILD_DATE=$(TZ=Asia/Tokyo date '+%Y年%m月%d日_%H時%M分%S秒')
#           FULL_ECR_REPO="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}"

#           echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
#           echo "image-uri=$FULL_ECR_REPO:$IMAGE_TAG" >> $GITHUB_OUTPUT
#           echo "build-date=$BUILD_DATE" >> $GITHUB_OUTPUT
#           echo "full-ecr-repo=$FULL_ECR_REPO" >> $GITHUB_OUTPUT
#           echo "deploy-env=production" >> $GITHUB_OUTPUT

#       - name: Build, tag, and push image to ECR (with cache optimization)
#         env:
#           DOCKER_BUILDKIT: 1
#           BUILDKIT_INLINE_CACHE: 1
#         run: |
#           IMAGE_TAG=${{ steps.build-info.outputs.image-tag }}
#           BUILD_DATE=${{ steps.build-info.outputs.build-date }}
#           FULL_ECR_REPO=${{ steps.build-info.outputs.full-ecr-repo }}

#           echo "Building Docker image with cache optimization..."
#           docker pull $FULL_ECR_REPO:${{ env.LATEST_TAG }} || true
          
#           docker build \
#             --cache-from $FULL_ECR_REPO:${{ env.LATEST_TAG }} \
#             --build-arg BUILD_DATE="$BUILD_DATE" \
#             --build-arg BUILD_TAG="$IMAGE_TAG" \
#             --build-arg RAILS_ENV=production \
#             --build-arg NODE_ENV=production \
#             -t $FULL_ECR_REPO:$IMAGE_TAG .

#           docker tag $FULL_ECR_REPO:$IMAGE_TAG $FULL_ECR_REPO:${{ env.LATEST_TAG }}

#           echo "Pushing Docker image to ECR..."
#           docker push $FULL_ECR_REPO:$IMAGE_TAG
#           docker push $FULL_ECR_REPO:${{ env.LATEST_TAG }}

#       - name: Extract assets from Docker image and upload to S3
#         run: |
#           IMAGE_TAG=${{ steps.build-info.outputs.image-tag }}
#           FULL_ECR_REPO=${{ steps.build-info.outputs.full-ecr-repo }}
          
#           echo "Extracting assets from Docker image..."
#           # Create temporary container to extract both assets and packs
#           CONTAINER_ID=$(docker create $FULL_ECR_REPO:$IMAGE_TAG)
#           docker cp $CONTAINER_ID:/app/public/assets ./extracted_assets
#           docker cp $CONTAINER_ID:/app/public/packs ./extracted_packs
#           docker rm $CONTAINER_ID
          
#           echo "Uploading Rails assets to S3..."
#           aws s3 sync ./extracted_assets/ s3://${{ env.S3_ASSETS_BUCKET }}/assets/ \
#             --cache-control "public, max-age=31536000, immutable" \
#             --exclude "*" \
#             --include "*.css" \
#             --include "*.js" \
#             --include "*.png" \
#             --include "*.svg" \
#             --include "*.woff*" \
#             --include "*.woff" \
#             --include "*.woff2" \
#             --include "*.ttf" \
#             --include "*.eot" \
#             --include "*.gz" \
#             --include "*.json"
          
#           echo "Uploading Webpacker assets (packs) to S3..."
#           aws s3 sync ./extracted_packs/ s3://${{ env.S3_ASSETS_BUCKET }}/packs/ \
#             --cache-control "public, max-age=31536000, immutable" \
#             --exclude "*" \
#             --include "*.css" \
#             --include "*.js" \
#             --include "*.png" \
#             --include "*.jpg" \
#             --include "*.jpeg" \
#             --include "*.gif" \
#             --include "*.svg" \
#             --include "*.woff*" \
#             --include "*.woff" \
#             --include "*.woff2" \
#             --include "*.ttf" \
#             --include "*.eot" \
#             --include "*.ico" \
#             --include "*.json" \
#             --include "*.gz" \
#             --include "*.br" \
#             --include "*.map" \
#             --include "*.txt"
          
#           echo "Cleaning up..."
#           rm -rf ./extracted_assets ./extracted_packs



#   deploy:
#     runs-on: ubuntu-latest
#     timeout-minutes: 10
#     needs: build
#     permissions:
#       id-token: write
#       contents: read

#     steps:
#       - name: Configure AWS credentials (OIDC)
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           role-to-assume: ${{ env.AWS_ROLE_ARN }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: ECS Force New Deployment
#         run: |
#           echo "Deploying image: ${{ needs.build.outputs.image-uri }}"
#           aws ecs update-service \
#             --cluster ${{ env.ECS_CLUSTER_NAME }} \
#             --service ${{ env.ECS_SERVICE_NAME }} \
#             --force-new-deployment \
#             --region ${{ env.AWS_REGION }}
