# S3データ移行手順書

## 概要

本番環境のS3データ（画像・ファイル）を新環境に移行します。

| 対象 | 内容 | 時間 | コスト |
|------|------|------|------|
| S3データ | 画像・ファイル（約100GB） | 30分-1時間 | 無料（同一リージョン内） |

**実行場所**: ローカルマシン（AWS CLI必須）

## 前提条件

1. AWS CLIがインストール済み
2. 適切なAWSプロファイルが設定済み
3. 移行元・移行先バケットへのアクセス権限あり
4. 移行元・移行先のバケット名とリージョンを把握済み

---

## S3データ移行

### 1. AWSプロファイル設定
```bash
# AWSプロファイルを設定（必要に応じて）
export AWS_PROFILE=904271084068

# プロファイル確認
aws sts get-caller-identity
```

### 2. 環境変数設定
```bash
export SRC_BUCKET="[本番バケット名]"
export SRC_REGION="ap-northeast-1"  # 東京リージョン
export DEST_BUCKET="[新環境バケット名]"
export DEST_REGION="ap-northeast-1"  # 東京リージョン
```

### 3. 移行前の確認
```bash
# 本番バケット容量確認
aws s3 ls s3://$SRC_BUCKET --recursive --human-readable --summarize

# 新環境バケット確認
aws s3 ls s3://$DEST_BUCKET
```

### 4. データ移行実行
```bash
# 東京リージョン内のS3間移行（転送料金無料）
aws s3 cp s3://$SRC_BUCKET s3://$DEST_BUCKET \
  --recursive \
  --source-region $SRC_REGION \
  --region $DEST_REGION
```

### 5. 移行後の確認
```bash
# 新環境バケット容量確認
aws s3 ls s3://$DEST_BUCKET --recursive --human-readable --summarize
```

---

## 補足情報

### S3移行の料金について
- **同一リージョン内移行**: データ転送料金無料（東京→東京）
- **クロスリージョン移行**: データ転送料金が発生

### データベース移行について
データベース移行の詳細手順は [07-DB復旧.md](./07-DB復旧.md) を参照してください。

---

## トラブルシューティング

### S3移行でエラーが発生した場合
```bash
# 部分的に失敗したファイルのみ再同期
aws s3 sync s3://$SRC_BUCKET s3://$DEST_BUCKET \
  --source-region $SRC_REGION \
  --region $DEST_REGION
```

### 移行進捗を確認したい場合
```bash
# リアルタイムで進捗表示
aws s3 cp s3://$SRC_BUCKET s3://$DEST_BUCKET \
  --recursive \
  --source-region $SRC_REGION \
  --region $DEST_REGION \
  --cli-read-timeout 0
```

### 権限エラーが発生した場合
- EC2インスタンスのIAMロールの権限を確認
- 移行元・移行先バケットのアクセス権限を確認