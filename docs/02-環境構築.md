# 環境構築（{env}）

## 概要
アプリケーションリソースを作成する

## ソース
- ステージング環境：tng-rails6/terraform/{env}
- 本番環境：tng-rails6/terraform/prod

## 特記事項

### ⚠️ エラー回避のための段階的実行
DNS検証が必要なリソース（ALB HTTPSリスナー）があるため、**必ず段階的に実行**してください：

1. **Phase 1**: 証明書リソース作成（DNS検証なし）
2. **DNS設定**: CloudflareにCNAMEレコード追加
3. **Phase 2**: 証明書検証リソース作成
4. **Phase 3**: 全体のデプロイ

### 証明書について
- **2つのACM証明書**が自動作成されます：
  - CloudFront用証明書（us-east-1リージョン）: `domain_name`
  - ALB用証明書（ap-northeast-1リージョン）: `alb-{domain_name}`（自動生成）
- 例：`s-rails-{env}-tokyo.sukejima.com` → `alb-s-rails-{env}-tokyo.sukejima.com`
- Phase 1では証明書は PENDING_VALIDATION 状態になります（正常）
- DNS設定完了後、Phase 2で証明書が ISSUED 状態になります

## 事前設定

- terraform/{env}/terraform_{env}.tfvarsの内容を編集してください。
- terraform/{env}/00-main.tf の backend "s3" のbucket設定とregion設定をtfstateのリモートバックエンドS3の名前に手動にて編集してください。
- terraform/{env}/00-main.tf の data "terraform_remote_state" "common" のbucket設定とregion設定およびkey設定をtfstateのリモートバックエンドS3の名前に手動にて編集してください。
- terraform/{env}/00-main.tf の locals.aws_region_stringの値を任意のリージョン省略名称に変更してください。
- **重要**: terraform/{env}/terraform_{env}.tfvars の `use_custom_domain` を `false` に設定してください（初回作成時は必須）。

## 作業手順（実際の作業順）

### Step 1: 初期セットアップ
```bash
cd terraform/{env}
terraform init
```

### Step 2: 証明書作成（ACM証明書のみ）

- **重要**: terraform/{env}/terraform_{env}.tfvars の `use_custom_domain` を `false` に設定してください（初回作成時は必須）。
```bash
# Warning: Resource targeting is in effectと警告がでますが、問題ありません
terraform apply -var-file="terraform_{env}.tfvars" \
  -target=aws_acm_certificate.cloudfront_cert \
  -target=aws_acm_certificate.alb_cert
```

### Step 3: DNS検証レコードの確認
```bash
# CloudFront用証明書のDNS検証レコードを取得
terraform output cloudfront_acm_dns_validations

# ALB用証明書のDNS検証レコードを取得
terraform output alb_acm_dns_validations
```

### Step 4: CloudflareにCNAMEレコード追加
上記コマンドで表示された**2つの異なるドメイン**のCNAMEレコードをCloudflareに追加してください
このとき,Cloudflareの「プロキシステータス」は'DNSのみ'にして追加をしてください

- **CloudFront用**: `cloudfront_acm_dns_validations` の検証レコード
- **ALB用**: `alb_acm_dns_validations` の検証レコード

### Step 5: 証明書発行の確認
AWS Console > Certificate Manager (ACM) で証明書が発行されるまで待機：

- **バージニア北部（us-east-1）**: `cloudfront_acm_dns_validations` が「発行済み」
- **東京（ap-northeast-1）**: `alb_acm_dns_validations` が「発行済み」

通常5-10分程度で発行されます。

### Step 6: 証明書検証リソースの作成
```bash

# Warning: Resource targeting is in effectと警告がでますが、問題ありません
terraform apply -var-file="terraform_{env}.tfvars" \
  -target=aws_acm_certificate_validation.cloudfront_cert_validation \
  -target=aws_acm_certificate_validation.alb_cert_validation
```

### Step 7: カスタムドメイン有効化
terraform_{env}.tfvarsファイルを編集：
```hcl
use_custom_domain = true
```

### Step 8: 段階的デプロイ

#### 8-1: デプロイ前の計画確認とログ保存
```bash
# デプロイ計画の確認とログ保存
terraform plan -var-file="terraform_{env}.tfvars" | tee ../../docs/terraform-plan-output-$(date +%Y%m%d-%H%M%S).txt

# 計画内容を確認してから次のステップへ
```

#### 8-2: 全体のデプロイ（一括実行）
```bash
# 全リソースを一括作成
terraform apply -var-file="terraform_{env}.tfvars" -auto-approve
```

**注意**:
- CloudFrontの作成には15-30分程度かかる場合があります。

### Step 9: CloudFrontとALBのドメインをCloudflareに設定


#### CloudFront用（ユーザーアクセス用）
```bash
# CloudFrontのドメイン名を取得
terraform output cloudfront_domain_name
```
Cloudflareに以下のCNAMEレコードを作成：
- **Name**: `s-rails-{env}-tokyo` (または設定したドメインのプレフィックス)
- **Type**: `CNAME`
- **Content**: 上記で取得したCloudFrontドメイン名

#### ALB用（CloudFront VPC Origin用）
```bash
# ALBのDNS名を取得
terraform output alb_dns_name
```
Cloudflareに以下のCNAMEレコードを作成：
- **Name**: `alb-s-rails-{env}-tokyo` (または設定したALB用ドメインのプレフィックス)
- **Type**: `CNAME`
- **Content**: 上記で取得したALBのDNS名

### Step 10: コンテナイメージの登録

#### 概要
ECSで使用するRailsアプリケーションのDockerイメージをECRに登録します。

#### 方法1: GitHub ActionsによるCI/CD（推奨）
GitHub Actionsを使用してコードのプッシュ時に自動でビルド・デプロイを行います。
- `.github/workflows/` 配下にワークフローファイルを配置
- コード変更時に自動でECRにプッシュ
- **静的アセット（JS/CSS）も同時にS3にデプロイされる**
- 詳細は各プロジェクトのCI/CD設定を参照

#### 方法2: 既存ECRからイメージコピー（一時的な対応）
他の環境のECRリポジトリからイメージをコピーする場合：

**詳細手順**: [`04-ECRイメージコピー.md`](./04-ECRイメージコピー.md)

**注意**: この方法では静的アセットはS3にコピーされません。完全な動作確認にはGitHub Actionsの実行を推奨します。

##### 確認
```bash
# ECRリポジトリのイメージを確認
aws ecr describe-images --repository-name {ECRリポジトリ名} --region ap-northeast-1
```

**注意**: イメージが登録されていない場合、ECSタスクの起動に失敗します。

##### ECSタスクの強制再起動
```bash
# ECSサービスを強制的に新しいデプロイメントで更新
aws ecs update-service \
  --cluster {作成されたECSクラスター名} \
  --service {作成されたECSサービス名} \
  --force-new-deployment \
  --region ap-northeast-1
```

##### ECSタスク状態の監視
```bash
# タスクの詳細状態を確認
aws ecs list-tasks \
  --cluster {作成されたECSクラスター名} \
  --service-name {作成されたECSサービス名} \
  --region ap-northeast-1

# タスクのログを確認（タスクARNを上記で取得後）
aws logs tail /ecs/{作成されたECSタスク名} --follow --region ap-northeast-1
```

**注意**: タスク起動には通常2-5分程度かかります。`RUNNING`状態になるまで待機してください。

### Step 11: 動作確認

#### 基本動作確認
```bash
# HTTPSアクセス確認
curl -I https://s-rails-{env}-tokyo.sukejima.com
```

#### 期待される動作
- **HTTPSアクセス**: 正常にレスポンスが返る
- **404エラー**: DBデータがないため404になる（正常）
- **Railsヘッダー**: X-Runtime、X-Request-IDが含まれる（Rails動作確認）
- **SSL証明書**: CloudFrontで正しく設定されている
- **X-Forwarded-Proto**: httpsが正しく設定される

#### 注意事項
- **静的アセット（JS/CSS）**: S3にデータがないため取得できない
- **推奨**: GitHub Actionsを実行してアセットを自動デプロイ
- **CSRF保護エラー（422）**: インフラが正常であれば解消される



## 構成図
```
ユーザー → CloudFront(s-rails-{env}-tokyo.sukejima.com)
         → ALB(alb-s-rails-{env}-tokyo.sukejima.com)
         → Rails(ECS)
```

## デバッグ・DB操作用リソース

### 概要
デバッグ・DB操作用リソースを管理します。

### 使用方法

#### 1. 初期化
```bash
cd terraform/{env}/debug/
terraform init
```

#### 2. デバッグ用リソースの作成
```bash
terraform apply -var-file=../terraform_{env}.tfvars
```

#### 3. DB復旧作業実行
詳細は `03-データ移行.md` を参照

#### 4. 作業完了後のクリーンアップ
EC2はつかわないときは停止するか、以下のコマンドでインスタンスを削除しておいてください。
セキュリティリスクやコスト対応の観点からです。またALBにはecho機能をもったリスナーが登録されます。
これはDebug目的であり、/echoでアクセスすると動作するため本番環境ではOFFに必ずしてください。
```bash
terraform destroy -var-file=../terraform_{env}.tfvars
```

### 注意事項
- このterraform/{env}/debugディレクトリのリソースはデバッグ用です
- メインのTerraform管理からは独立しています

### 作成される主要リソース

| リソース | 用途 | スペック | 備考 |
|---------|------|----------|------|
| **EC2インスタンス** | DB復旧・デバッグ作業 | t3.large (メモリ8GB) | PostgreSQL、AWS CLI導入済み、SSM接続のみ |
| **Lambda関数** | echoサーバー | python3.9 | `/echo`エンドポイントでテスト可能 |

## Tips

### 1.ローカルからRDSに接続したいとき
**詳細手順**: [`05-SSM運用操作.md`](./05-SSM運用操作.md)
- SSM Session Managerでの接続
- RDSへの直接アクセス
- SSMポートフォワーディングでGUIツール接続（DBeaver、pgAdmin等）

### 2.ECSタスクのコンテナーにExecして実際のアプリコンテナのシェル操作をしたいとき
**詳細手順**: [`06-運用操作.md`](./06-運用操作.md#ecsタスクへの接続)
- ECS Execでのシェル接続
- Railsコンソール接続
- ログ監視・動作確認


