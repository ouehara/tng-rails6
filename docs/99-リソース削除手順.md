# Terraform削除コマンド

## 簡単な削除方法

### 全削除（推奨）
```bash
#export AWS_PROFILE=920096438558-suke2
#terraform destroy -var-file="terraform_dev.tfvars" -auto-approve
```

## 段階的削除（問題発生時または細かく制御したい場合）

### Phase 1: CloudFront削除（最も時間がかかる）
```bash
export AWS_PROFILE=920096438558-suke2

# CloudFront Distribution削除（15-30分かかる）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_cloudfront_distribution.s3_distribution \
  -auto-approve
```

### Phase 2: CloudFront関連リソース削除
```bash
# CloudFront VPC Origin削除（数分）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_cloudfront_vpc_origin.alb_vpc_origin \
  -target=aws_cloudfront_origin_access_control.s3_oac \
  -auto-approve
```

### Phase 3: WAF削除
```bash
# WAF削除（数秒）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_wafv2_web_acl.cloudfront_waf \
  -target=aws_wafv2_ip_set.developer_ip_whitelist \
  -auto-approve
```

### Phase 4: ALB削除
```bash
# ALB削除（1-2分）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_lb_listener.alb_listener_https \
  -target=aws_lb_target_group.alb_tg \
  -target=aws_lb.alb \
  -auto-approve
```

### Phase 5: ECSサービス削除
```bash
# ECSサービス・クラスター削除（数秒）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_ecs_service.rails_app_service \
  -target=aws_ecs_cluster.app_cluster \
  -auto-approve
```

### Phase 6: ECSタスク・ログ削除
```bash
# ECSタスク定義削除（数秒）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_ecs_task_definition.rails_app_task \
  -target=aws_ecs_task_definition.rails_batch_missing_images \
  -target=aws_ecs_task_definition.rails_batch_sitemap_refresh \
  -target=aws_ecs_task_definition.rails_batch_xml_articles \
  -auto-approve

# CloudWatch Events削除（数秒）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_cloudwatch_event_target.missing_images_target \
  -target=aws_cloudwatch_event_target.sitemap_refresh_target \
  -target=aws_cloudwatch_event_target.xml_articles_target \
  -target=aws_cloudwatch_event_rule.missing_images_schedule \
  -target=aws_cloudwatch_event_rule.sitemap_refresh_schedule \
  -target=aws_cloudwatch_event_rule.xml_articles_schedule \
  -auto-approve

# CloudWatch Logs削除（数秒）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_cloudwatch_log_group.ecs_task_logs \
  -target=aws_cloudwatch_log_group.rails_batch_logs \
  -auto-approve
```

### Phase 7: RDS削除
```bash
# RDS削除（5-15分かかる、最終スナップショット作成のため）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_db_instance.rds_instance \
  -target=aws_db_subnet_group.db_subnet \
  -auto-approve
```

### Phase 8: ElastiCache削除

**注意**: RDSとElastiCacheは並行で実行可能です
```bash
# ElastiCache削除（3-10分かかる）
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_elasticache_cluster.memcached \
  -target=aws_elasticache_parameter_group.memcached_params \
  -target=aws_elasticache_subnet_group.memcached_subnet_group \
  -auto-approve
```

### Phase 9: S3データ削除（事前作業）

**重要**: S3バケットにファイルがある場合、Terraformでは削除できません。事前にデータを削除してください。

```bash
# S3バケット名を取得
export AWS_PROFILE=920096438558-suke2
export BUCKET_NAME=$(terraform output -raw s3_bucket_name 2>/dev/null || echo "s-rails-0930-dev-apn1-static-assets-2ijc7gye")
echo "バケット名: $BUCKET_NAME"

# バケット内のファイル数確認
aws s3 ls s3://$BUCKET_NAME --recursive --summarize

# バケット内の全ファイルを削除（注意：復元不可！）
aws s3 rm s3://$BUCKET_NAME --recursive

# バージョニング有効の場合、削除マーカーと不完全なマルチパートアップロードも削除
aws s3api list-object-versions --bucket $BUCKET_NAME --query 'DeleteMarkers[].{Key:Key,VersionId:VersionId}' --output text | while read key version; do
  [ -n "$key" ] && aws s3api delete-object --bucket $BUCKET_NAME --key "$key" --version-id "$version"
done

aws s3api list-object-versions --bucket $BUCKET_NAME --query 'Versions[].{Key:Key,VersionId:VersionId}' --output text | while read key version; do
  [ -n "$key" ] && aws s3api delete-object --bucket $BUCKET_NAME --key "$key" --version-id "$version"
done

# 不完全なマルチパートアップロードをクリーンアップ
aws s3api list-multipart-uploads --bucket $BUCKET_NAME --query 'Uploads[].{Key:Key,UploadId:UploadId}' --output text | while read key upload_id; do
  [ -n "$key" ] && aws s3api abort-multipart-upload --bucket $BUCKET_NAME --key "$key" --upload-id "$upload_id"
done

# 空のバケットであることを確認
aws s3 ls s3://$BUCKET_NAME --recursive || echo "バケットは空です"
```

### Phase 10: S3バケット削除

上記でデータを削除した後、TerraformでS3バケットと関連設定を削除：

```bash
# S3バケットと設定を削除
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_s3_bucket_cors_configuration.static_assets_cors \
  -target=aws_s3_bucket_lifecycle_configuration.static_assets_lifecycle \
  -target=aws_s3_bucket_server_side_encryption_configuration.static_assets_encryption \
  -target=aws_s3_bucket_versioning.static_assets_versioning \
  -target=aws_s3_bucket_public_access_block.static_assets_pab \
  -target=aws_s3_bucket.static_assets \
  -auto-approve
```

### Phase 11: IAM削除
```bash
# IAMポリシー・ロール削除
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_iam_access_key.s3_static_assets_access_key \
  -target=aws_iam_user_policy_attachment.s3_static_assets_policy_attachment \
  -target=aws_iam_user.s3_static_assets_user \
  -target=aws_iam_role_policy_attachment.github_actions_s3_assets \
  -target=aws_iam_role_policy_attachment.ecs_task_role_ssm_exec \
  -target=aws_iam_role_policy_attachment.ecs_task_role_attach \
  -target=aws_iam_role_policy_attachment.ecs_execution_role_ssm \
  -target=aws_iam_role_policy_attachment.ecs_execution_role_ecr_attach \
  -target=aws_iam_role_policy_attachment.ecs_execution_role_cloudwatch_logs \
  -target=aws_iam_role_policy_attachment.ecs_execution_role_attach \
  -target=aws_iam_role_policy.eventbridge_ecs_policy \
  -target=aws_iam_policy.s3_static_assets_policy \
  -target=aws_iam_policy.github_actions_s3_assets_policy \
  -target=aws_iam_policy.ecs_ssm_exec_limited \
  -target=aws_iam_policy.ecs_cloudwatch_logs_limited \
  -target=aws_iam_role.eventbridge_ecs_role \
  -target=aws_iam_role.ecs_task_role \
  -target=aws_iam_role.ecs_execution_role \
  -auto-approve
```

### Phase 12: ネットワーク削除（最後）
```bash
# セキュリティグループルール削除
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_security_group_rule.ecs_to_vpc_endpoint \
  -target=aws_security_group_rule.ecs_to_rds \
  -auto-approve

# セキュリティグループ削除
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_security_group.vpc_endpoint_sg \
  -target=aws_security_group.rds_sg \
  -target=aws_security_group.memcached_sg \
  -target=aws_security_group.ecs_sg \
  -target=aws_security_group.alb_sg \
  -auto-approve

# VPCエンドポイント削除
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_vpc_endpoint.ssmmessages \
  -target=aws_vpc_endpoint.ssm \
  -target=aws_vpc_endpoint.s3 \
  -target=aws_vpc_endpoint.ecr_dkr \
  -target=aws_vpc_endpoint.ecr_api \
  -target=aws_vpc_endpoint.ec2messages \
  -target=aws_vpc_endpoint.cloudwatch_logs \
  -auto-approve

# ルートテーブル削除
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_route_table_association.private_rta \
  -target=aws_route_table.private_rt \
  -auto-approve

# サブネット・VPC削除
terraform destroy -var-file="terraform_dev.tfvars" \
  -target=aws_subnet.private_subnet \
  -target=aws_internet_gateway.igw \
  -target=aws_vpc.vpc \
  -auto-approve
```

### Phase 13: 最終確認
```bash
# 残りのリソース削除
terraform destroy -var-file="terraform_dev.tfvars" -auto-approve
```

## 注意事項

### 時間の目安
- **CloudFront削除**: 15-30分かかる
- **RDS削除**: 5-15分かかる
- **ElastiCache削除**: 3-10分かかる
- **その他のリソース**: 数秒から数分

### DNS依存関係について
- 検証結果、CloudFrontのカスタムドメインでもDNSエラーは発生しません
- DNSレコードを事前に削除する必要は通常ありません
- エラーが発生した場合はCloudflareでCNAMEレコードを削除してください

### 並行実行可能
- **RDSとElastiCache**は同時に削除可能

### その他
- **S3にファイルがある場合はPhase 9で事前削除が必須**
- **削除は取り消しできません**
- **AWS_PROFILEを必ず設定してください**
- **証明書はPhase 4でALBと同時に削除済みです**

### 残存リソース確認コマンド
```bash
# 残っているリソースの確認
terraform state list

# 特定リソースの状態確認
terraform state show リソース名

# 削除予定のリソース確認
terraform plan -destroy -var-file="terraform_dev.tfvars"
```

### ダングリングリソースの強制削除
ステートに残っているが実際には存在しないリソースをステートから除去：
```bash
# 例：存在しないリソースをステートから除去
terraform state rm リソース名

# または、ステートをリフレッシュして実際の状態と同期
terraform refresh -var-file="terraform_dev.tfvars"
```

## 検証済み
この手順書は2025年9月29日に実際の段階的削除で検証されています。