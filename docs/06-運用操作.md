# 運用手順

## ECSサービス停止・再開手順

### 環境変数設定
```bash
# 基本設定
export AWS_REGION="us-west-2"

# ECSクラスター名を動的取得
export ECS_CLUSTER=$(aws ecs list-clusters \
  --query 'clusterArns[?contains(@, `app-cluster`)][0]' \
  --output text \
  --region $AWS_REGION | cut -d'/' -f2)

# ECSサービス名を動的取得
export ECS_SERVICE=$(aws ecs list-services \
  --cluster $ECS_CLUSTER \
  --query 'serviceArns[?contains(@, `app-service`)][0]' \
  --output text \
  --region $AWS_REGION | cut -d'/' -f3)

# バッチジョブキュー名を動的取得
export BATCH_JOB_QUEUE=$(aws batch describe-job-queues \
  --query 'jobQueues[?contains(jobQueueName, `batch-job-queue`)].jobQueueName[0]' \
  --output text \
  --region $AWS_REGION)

echo "ECS Cluster: $ECS_CLUSTER"
echo "ECS Service: $ECS_SERVICE"
echo "Batch Job Queue: $BATCH_JOB_QUEUE"
```

### ECSクラスターとバッチジョブ停止
```bash
# ECSサービスを0タスクに設定（停止）
aws ecs update-service \
  --cluster $ECS_CLUSTER \
  --service $ECS_SERVICE \
  --desired-count 0 \
  --region $AWS_REGION

# バッチジョブキューを無効化
aws batch update-job-queue \
  --job-queue $BATCH_JOB_QUEUE \
  --state DISABLED \
  --region $AWS_REGION

# 実行中のバッチジョブ確認と停止
echo "実行中バッチジョブ確認中..."
RUNNING_JOBS=$(aws batch list-jobs \
  --job-queue $BATCH_JOB_QUEUE \
  --job-status RUNNING \
  --query 'jobList[].jobId' \
  --output text \
  --region $AWS_REGION)

echo "実行中バッチジョブを停止: $RUNNING_JOBS"
for job_id in $RUNNING_JOBS; do
  aws batch cancel-job --job-id $job_id --reason "Maintenance operation" --region $AWS_REGION
done
```

### ECSクラスターとバッチジョブ再開
```bash
# ECSサービスを1タスクに復旧
aws ecs update-service \
  --cluster $ECS_CLUSTER \
  --service $ECS_SERVICE \
  --desired-count 1 \
  --region $AWS_REGION

# バッチジョブキューを有効化
aws batch update-job-queue \
  --job-queue $BATCH_JOB_QUEUE \
  --state ENABLED \
  --region $AWS_REGION

# ECSタスク起動確認（最大5分待機）
echo "ECSタスク起動確認中..."
for i in {1..30}; do
  RUNNING_TASKS=$(aws ecs list-tasks \
    --cluster $ECS_CLUSTER \
    --service-name $ECS_SERVICE \
    --desired-status RUNNING \
    --query 'length(taskArns)' \
    --output text \
    --region $AWS_REGION)

  if [ "$RUNNING_TASKS" = "1" ]; then
    echo "ECSタスク起動完了"
    break
  else
    echo "ECSタスク起動待機中... ($i/30)"
    sleep 10
  fi
done
```

## アプリケーション動作確認

### ALBヘルスチェック確認
```bash
# ALBとターゲットグループを動的取得
ALB_ARN=$(aws elbv2 describe-load-balancers \
  --query 'LoadBalancers[?contains(LoadBalancerName, `alb`)].LoadBalancerArn[0]' \
  --output text \
  --region $AWS_REGION)

TARGET_GROUP_ARN=$(aws elbv2 describe-target-groups \
  --query 'TargetGroups[?contains(TargetGroupName, `tg`)].TargetGroupArn[0]' \
  --output text \
  --region $AWS_REGION)

echo "ALBヘルスチェック確認中..."
for i in {1..20}; do
  HEALTHY_TARGETS=$(aws elbv2 describe-target-health \
    --target-group-arn $TARGET_GROUP_ARN \
    --query 'TargetHealthDescriptions[?TargetHealth.State==`healthy`].Target.Id' \
    --output text \
    --region $AWS_REGION)

  if [ ! -z "$HEALTHY_TARGETS" ]; then
    echo "ALBヘルスチェック: 正常 (Healthy targets: $HEALTHY_TARGETS)"
    break
  else
    echo "ALBヘルスチェック待機中... ($i/20)"
    sleep 15
  fi
done
```

### アプリケーションエンドポイント確認
```bash
# ヘルスチェックエンドポイント
HEALTH_CHECK_URL="https://tng-dev-uswest2.sukejima.com/health"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" || echo "000")
echo "ヘルスチェック ($HEALTH_CHECK_URL): HTTP $HTTP_STATUS"

# Railsルートページ確認
ROOT_URL="https://tng-dev-uswest2.sukejima.com/"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$ROOT_URL" || echo "000")
echo "ルートページ ($ROOT_URL): HTTP $HTTP_STATUS"

# CloudFront確認
CLOUDFRONT_URL="https://d3dzqz8lbd62uk.cloudfront.net/"
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$CLOUDFRONT_URL" || echo "000")
echo "CloudFront ($CLOUDFRONT_URL): HTTP $HTTP_STATUS"
```

## ECSタスクへの接続

### 事前確認
```bash
# AWS認証確認
aws sts get-caller-identity --region us-west-2

# クラスター確認
aws ecs list-clusters --region us-west-2

# サービス状態確認
aws ecs describe-services \
  --cluster m-rails-0927-dev-useast2-app-cluster \
  --services m-rails-0927-dev-useast2-app-service \
  --region us-west-2
```

### 実行中タスクの特定
```bash
# 実行中タスク一覧
aws ecs list-tasks \
  --cluster m-rails-0927-dev-useast2-app-cluster \
  --service-name m-rails-0927-dev-useast2-app-service \
  --region us-west-2

# タスク詳細確認
TASK_ARN=$(aws ecs list-tasks \
  --cluster m-rails-0927-dev-useast2-app-cluster \
  --service-name m-rails-0927-dev-useast2-app-service \
  --query 'taskArns[0]' \
  --output text \
  --region us-west-2)

TASK_ID=$(echo $TASK_ARN | cut -d'/' -f3)
echo "ECSタスクID: $TASK_ID"

# タスク状態詳細確認
aws ecs describe-tasks \
  --cluster m-rails-0927-dev-useast2-app-cluster \
  --tasks $TASK_ID \
  --region us-west-2
```

### ECS Execでのシェル接続
```bash
# コンテナに接続（docker exec相当）
aws ecs execute-command \
  --cluster m-rails-0927-dev-useast2-app-cluster \
  --task $TASK_ID \
  --container app \
  --interactive \
  --command '/bin/bash' \
  --region us-west-2
```

### 接続後の動作確認
```bash
# Ruby/Rails環境確認
ruby -v
rails -v

# プロセス確認
ps aux | grep ruby
ps aux | grep puma

# 環境変数確認
env | grep RAILS
env | grep DATABASE

# アプリケーションヘルスチェック
curl localhost:3000/health

# curlが使えない場合の代替確認
netstat -tlnp | grep 3000

# ログ確認
tail -f log/production.log
```

### Railsコンソール接続
```bash
# Railsコンソール起動
bundle exec rails console

# データベース確認コマンド例
# User.count
# ActiveRecord::Base.connection.tables.count
# ActiveRecord::Base.connection.execute("SELECT version()")
# Rails.application.routes.url_helpers.health_path
```

## ログ監視

### ECSタスクログ確認
```bash
# CloudWatch Logsストリーム確認
aws logs describe-log-streams \
  --log-group-name /ecs/m-rails-0927-dev-useast2-app-task \
  --order-by LastEventTime \
  --descending \
  --max-items 5 \
  --region us-west-2

# 最新ログ取得
LOG_STREAM_NAME="[上記で取得したストリーム名]"
aws logs get-log-events \
  --log-group-name /ecs/m-rails-0927-dev-useast2-app-task \
  --log-stream-name $LOG_STREAM_NAME \
  --start-from-head \
  --region us-west-2
```

### バッチタスクログ確認
```bash
# バッチタスクログ確認
aws logs describe-log-streams \
  --log-group-name /ecs/m-rails-0927-dev-useast2-batch-tasks \
  --order-by LastEventTime \
  --descending \
  --max-items 5 \
  --region us-west-2
```

## リソース状態確認

### EC2インスタンス確認
```bash
# デバッグ用EC2インスタンス状態確認
aws ec2 describe-instances \
  --filters "Name=tag:Name,Values=m-rails-0927-dev-useast2-ec2-db-restore" \
  --query 'Reservations[].Instances[].{InstanceId:InstanceId,State:State.Name,PublicIP:PublicIpAddress}' \
  --region us-west-2
```

### RDS状態確認
```bash
# RDSインスタンス状態確認
aws rds describe-db-instances \
  --db-instance-identifier m-rails-0927-dev-useast2-db-v2 \
  --query 'DBInstances[].{Status:DBInstanceStatus,Endpoint:Endpoint.Address}' \
  --region us-west-2
```

### S3バケット確認
```bash
# S3バケット一覧とサイズ確認
aws s3 ls s3://m-rails-0927-dev-useast2-static-assets --human-readable --summarize --region us-west-2
```

## セキュリティ運用

### IAMロール確認
```bash
# ECSタスクロール権限確認
aws iam list-attached-role-policies \
  --role-name m-rails-0927-dev-useast2-task-role

# ECS実行ロール権限確認
aws iam list-attached-role-policies \
  --role-name m-rails-0927-dev-useast2-task-execution-role
```

### セキュリティグループ確認
```bash
# ALBセキュリティグループ確認
aws ec2 describe-security-groups \
  --filters "Name=tag:Name,Values=m-rails-0927-dev-useast2-alb-sg" \
  --query 'SecurityGroups[].{GroupId:GroupId,Rules:IpPermissions}' \
  --region us-west-2

# ECSセキュリティグループ確認
aws ec2 describe-security-groups \
  --filters "Name=tag:Name,Values=m-rails-0927-dev-useast2-ecs-sg" \
  --query 'SecurityGroups[].{GroupId:GroupId,Rules:IpPermissions}' \
  --region us-west-2
```

## 緊急時対応

### 全サービス緊急停止
```bash
# ECSサービス緊急停止
aws ecs update-service \
  --cluster m-rails-0927-dev-useast2-app-cluster \
  --service m-rails-0927-dev-useast2-app-service \
  --desired-count 0 \
  --region us-west-2

# CloudFront無効化（必要に応じて）
DISTRIBUTION_ID="d1qraj6i5qs51h"
aws cloudfront create-invalidation \
  --distribution-id $DISTRIBUTION_ID \
  --paths "/*"
```

### 緊急復旧
```bash
# ECSサービス復旧
aws ecs update-service \
  --cluster m-rails-0927-dev-useast2-app-cluster \
  --service m-rails-0927-dev-useast2-app-service \
  --desired-count 1 \
  --region us-west-2

# ヘルスチェック確認
sleep 60
curl -I https://tng-dev-uswest2.sukejima.com/health
```