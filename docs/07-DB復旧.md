# データベース移行手順書

## 概要

本番環境のPostgreSQLデータベースを新環境に移行します。

| 対象 | 内容 | 時間 | コスト |
|------|------|------|------|
| PostgreSQL | ダンプファイル復元（約25GB） | 30分-1時間 | 約66円 |

**実行場所**: EC2インスタンス（terraform/dev/debug で作成）

## 前提条件

1. `terraform/dev/debug` でデバッグ用リソースが作成済み
2. 本番データベースのダンプファイルがS3に配置済み
3. EC2インスタンスにSSMでアクセス可能

---

## 手順

### 1. EC2インスタンスにログイン

```bash
# SSMでログイン
export INSTANCE_ID=$(terraform -chdir=terraform/dev/debug output -raw ec2_instance_id)
aws ssm start-session --target $INSTANCE_ID --region ap-northeast-1
```

### 2. ダンプファイルの配置とデータベース復元

```bash
# 環境変数設定
export AWS_DEFAULT_REGION=ap-northeast-1
export TEMP_BUCKET_NAME="[terraform/dev/debugで作成されたS3バケット名]"

# 本番ダンプファイルを一時バケットにコピー（AWS内部通信のため無料）
aws s3 cp \
  s3://[本番バケット]/[ダンプファイル].sql.zip \
  s3://$TEMP_BUCKET_NAME/[ダンプファイル].sql.zip \
  --source-region ap-northeast-1 \
  --region ap-northeast-1

# ダンプファイルをEC2にダウンロード（AWS内部通信のため無料）
aws s3 cp s3://$TEMP_BUCKET_NAME/[ダンプファイル].sql.zip /tmp/

# ファイル展開
cd /tmp
unzip -o [ダンプファイル].sql.zip

# RDS接続情報設定
export DB_HOST="[RDSエンドポイント]"
export DB_USER="postgres"
export DB_NAME="mydatabasev2"
export DB_PASSWORD="password"

# データベース接続テスト
PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -c "SELECT version();"

# 既存データ削除
PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -c "
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO public;"

# データベース復元実行（ログ保存）
echo "データベース復元開始: $(date)" | tee /tmp/db_restore.log
PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" \
  -v ON_ERROR_STOP=1 \
  --single-transaction \
  -f [ダンプファイル].sql 2>&1 | tee -a /tmp/db_restore.log
echo "データベース復元完了: $(date)" | tee -a /tmp/db_restore.log

# 復元確認
PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -c "\dt" | tee -a /tmp/db_restore.log

# ログ確認
echo "ログファイル: /tmp/db_restore.log"
```

---

## トラブルシューティング

### データベース接続エラーの場合
- RDSエンドポイントが正しいか確認
- セキュリティグループの設定を確認
- パスワードが正しいか確認

### ダンプファイルが見つからない場合
- 一時S3バケット名が正しいか確認
- ファイルが正常にアップロードされているか確認

### 復元中にエラーが発生した場合
```bash
# エラー詳細を確認
PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -c "\d"

# 再度スキーマを削除して復元をやり直し
PGPASSWORD="$DB_PASSWORD" psql -h "$DB_HOST" -U "$DB_USER" -d "$DB_NAME" -c "
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;"
```